!function(e,t){for(var n in t)e[n]=t[n]}(exports,function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1)}([function(e,t){e.exports=require("vscode")},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))(function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){e.done?r(e.value):function(e){return e instanceof n?e:new n(function(t){t(e)})}(e.value).then(s,c)}a((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const r=n(0),i=n(2);t.activate=function(e){return o(this,void 0,void 0,function*(){const e=new i.AzureActiveDirectoryService;yield e.initialize(),r.authentication.registerAuthenticationProvider({id:"MSA",displayName:"Microsoft",onDidChangeSessions:i.onDidChangeSessions.event,getSessions:()=>Promise.resolve(e.sessions),login:t=>o(this,void 0,void 0,function*(){try{return yield e.login(t.sort().join(" ")),e.sessions[0]}catch(e){throw r.window.showErrorMessage(`Logging in failed: ${e}`),e}}),logout:t=>o(this,void 0,void 0,function*(){return e.logout(t)})})})},t.deactivate=function(){}},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))(function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){e.done?r(e.value):function(e){return e instanceof n?e:new n(function(t){t(e)})}(e.value).then(s,c)}a((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const r=n(3),i=n(4),s=n(5),c=n(0),a=n(6),u=n(11),d=n(13),l=n(14),h="https://vscode-redirect.azurewebsites.net/",f="https://login.microsoftonline.com/",p="aebc6443-996d-45c2-90f0-388ff96faa56",g="organizations";t.onDidChangeSessions=new c.EventEmitter;class v extends c.EventEmitter{handleUri(e){this.fire(e)}}t.AzureActiveDirectoryService=class{constructor(){this._tokens=[],this._refreshTimeouts=new Map,this._uriHandler=new v,c.window.registerUriHandler(this._uriHandler)}initialize(){return o(this,void 0,void 0,function*(){const e=yield u.keychain.getToken();if(e)try{const t=this.parseStoredData(e),n=Object.create(null),r=t.filter(e=>!n[e.id]&&(n[e.id]=!0,!0)).map(e=>o(this,void 0,void 0,function*(){try{yield this.refreshToken(e.refreshToken,e.scope)}catch(t){yield this.logout(e.id)}}));yield Promise.all(r)}catch(e){yield this.clearSessions()}this.pollForChange()})}parseStoredData(e){return JSON.parse(e)}storeTokenData(){return o(this,void 0,void 0,function*(){const e=this._tokens.map(e=>({id:e.sessionId,refreshToken:e.refreshToken,scope:e.scope}));yield u.keychain.setToken(JSON.stringify(e))})}pollForChange(){setTimeout(()=>o(this,void 0,void 0,function*(){let e=!1;const n=yield u.keychain.getToken();if(n)try{const t=this.parseStoredData(n);let r=t.map(t=>o(this,void 0,void 0,function*(){if(!this._tokens.some(e=>e.scope===t.scope&&e.sessionId===t.id))try{yield this.refreshToken(t.refreshToken,t.scope),e=!0}catch(e){yield this.logout(t.id)}}));r=r.concat(this._tokens.map(n=>o(this,void 0,void 0,function*(){t.some(e=>n.scope===e.scope&&n.sessionId===e.id)||(yield this.logout(n.sessionId),e=!0)}))),yield Promise.all(r)}catch(t){d.default.error(t.message),this.clearSessions(),e=!0}else this._tokens.length&&(yield this.clearSessions(),e=!0);e&&t.onDidChangeSessions.fire(),this.pollForChange()}),3e4)}convertToSession(e){return{id:e.sessionId,accessToken:e.accessToken,displayName:e.displayName,scopes:e.scope.split(" ")}}getTokenClaims(e){try{return JSON.parse(Buffer.from(e.split(".")[1],"base64").toString())}catch(e){throw d.default.error(e.message),new Error("Unable to read token claims")}}get sessions(){return this._tokens.map(e=>this.convertToSession(e))}login(e){return o(this,void 0,void 0,function*(){if(d.default.info("Logging in..."),c.env.uiKind===c.UIKind.Web)return void(yield this.loginWithoutLocalServer(e));const t=r.randomBytes(16).toString("base64"),{server:n,redirectPromise:o,codePromise:i}=a.createServer(t);let s;try{const u=yield a.startServer(n);c.env.openExternal(c.Uri.parse(`http://localhost:${u}/signin?nonce=${encodeURIComponent(t)}`));const v=yield o;if("err"in v){const{err:e,res:t}=v;throw t.writeHead(302,{Location:`/?error=${encodeURIComponent(e&&e.message||"Unknown error")}`}),t.end(),e}const m=v.req.headers.host||"",y=(/^[^:]+:(\d+)$/.exec(Array.isArray(m)?m[0]:m)||[])[1],w=`${y?parseInt(y,10):u},${encodeURIComponent(t)}`,k=l.toBase64UrlEncoding(r.randomBytes(32).toString("base64")),_=l.toBase64UrlEncoding(r.createHash("sha256").update(k).digest("base64")),T=`${f}${g}/oauth2/v2.0/authorize?response_type=code&response_mode=query&client_id=${encodeURIComponent(p)}&redirect_uri=${encodeURIComponent(h)}&state=${w}&scope=${encodeURIComponent(e)}&prompt=select_account&code_challenge_method=S256&code_challenge=${_}`;yield v.res.writeHead(302,{Location:T}),v.res.end();const S=yield i,x=S.res;try{if("err"in S)throw S.err;s=yield this.exchangeCodeForToken(S.code,k,e),this.setToken(s,e),d.default.info("Login successful"),x.writeHead(302,{Location:"/"}),x.end()}catch(e){d.default.error(e.message),x.writeHead(302,{Location:`/?error=${encodeURIComponent(e&&e.message||"Unknown error")}`}),x.end()}}catch(t){d.default.error(t.message),"Error listening to server"!==t.message&&"Closed"!==t.message&&"Timeout waiting for port"!==t.message||(yield this.loginWithoutLocalServer(e))}finally{setTimeout(()=>{n.close()},5e3)}})}getCallbackEnvironment(e){switch(e.authority){case"online.visualstudio.com,":return"vso";case"online-ppe.core.vsengsaas.visualstudio.com":return"vsoppe,";case"online.dev.core.vsengsaas.visualstudio.com":return"vsodev,";default:return""}}loginWithoutLocalServer(e){return o(this,void 0,void 0,function*(){const t=yield c.env.asExternalUri(c.Uri.parse(`${c.env.uriScheme}://vscode.vscode-account`)),n=r.randomBytes(16).toString("base64"),o=(t.authority.match(/:([0-9]*)$/)||[])[1]||("https"===t.scheme?443:80),i=`${this.getCallbackEnvironment(t)}${o},${encodeURIComponent(n)},${encodeURIComponent(t.query)}`,s=`${f}${g}/oauth2/v2.0/authorize`;let a=c.Uri.parse(s);const u=l.toBase64UrlEncoding(r.randomBytes(32).toString("base64")),d=l.toBase64UrlEncoding(r.createHash("sha256").update(u).digest("base64"));a=a.with({query:`response_type=code&client_id=${encodeURIComponent(p)}&response_mode=query&redirect_uri=${h}&state=${i}&scope=${e}&prompt=select_account&code_challenge_method=S256&code_challenge=${d}`}),c.env.openExternal(a);const v=new Promise((e,t)=>{const n=setTimeout(()=>{clearTimeout(n),t("Login timed out.")},3e5)});return Promise.race([this.handleCodeResponse(i,u,e),v])})}handleCodeResponse(e,t,n){return o(this,void 0,void 0,function*(){let r;return new Promise((i,s)=>{r=this._uriHandler.event(r=>o(this,void 0,void 0,function*(){try{const o=function(e){return e.query.split("&").reduce((e,t)=>{const n=t.split("=");return e[n[0]]=n[1],e},{})}(r),c=o.code;if(o.state!==e)throw new Error("State does not match.");const a=yield this.exchangeCodeForToken(c,t,n);this.setToken(a,n),i(a)}catch(e){s(e)}}))}).then(e=>(r.dispose(),e)).catch(e=>{throw r.dispose(),e})})}setToken(e,n){return o(this,void 0,void 0,function*(){const r=this._tokens.findIndex(t=>t.sessionId===e.sessionId);r>-1?this._tokens.splice(r,1,e):this._tokens.push(e);const i=this._refreshTimeouts.get(e.sessionId);i&&clearTimeout(i),this._refreshTimeouts.set(e.sessionId,setTimeout(()=>o(this,void 0,void 0,function*(){try{yield this.refreshToken(e.refreshToken,n)}catch(t){yield this.logout(e.sessionId)}finally{t.onDidChangeSessions.fire()}}),1e3*(parseInt(e.expiresIn)-30))),this.storeTokenData()})}getTokenFromResponse(e,t){const n=JSON.parse(Buffer.concat(e).toString()),o=this.getTokenClaims(n.access_token);return{expiresIn:n.expires_in,accessToken:n.access_token,refreshToken:n.refresh_token,scope:t,sessionId:o.tid+(o.oid||o.altsecid)+t,displayName:o.email||o.unique_name||"user@example.com"}}exchangeCodeForToken(e,t,n){return o(this,void 0,void 0,function*(){return new Promise((o,r)=>{d.default.info("Exchanging login code for token");try{const a=s.stringify({grant_type:"authorization_code",code:e,client_id:p,scope:n,code_verifier:t,redirect_uri:h}),u=c.Uri.parse(`${f}${g}/oauth2/v2.0/token`),l=i.request({host:u.authority,path:u.path,method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","Content-Length":a.length}},e=>{const t=[];e.on("data",e=>{t.push(e)}),e.on("end",()=>{200===e.statusCode?(d.default.info("Exchanging login code for token success"),o(this.getTokenFromResponse(t,n))):(d.default.error("Exchanging login code for token failed"),r(new Error("Unable to login.")))})});l.write(a),l.end(),l.on("error",e=>{r(e)})}catch(e){d.default.error(e.message),r(e)}})})}refreshToken(e,t){return o(this,void 0,void 0,function*(){return new Promise((n,r)=>{d.default.info("Refreshing token...");const c=s.stringify({refresh_token:e,client_id:p,grant_type:"refresh_token",scope:t}),a=i.request({host:"login.microsoftonline.com",path:`/${g}/oauth2/v2.0/token`,method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","Content-Length":c.length}},e=>{const i=[];e.on("data",e=>{i.push(e)}),e.on("end",()=>o(this,void 0,void 0,function*(){if(200===e.statusCode){const e=this.getTokenFromResponse(i,t);this.setToken(e,t),d.default.info("Token refresh success"),n(e)}else d.default.error("Refreshing token failed"),r(new Error("Refreshing token failed."))}))});a.write(c),a.end(),a.on("error",e=>{d.default.error(e.message),r(e)})})})}logout(e){return o(this,void 0,void 0,function*(){d.default.info(`Logging out of session '${e}'`);const t=this._tokens.findIndex(t=>t.sessionId===e);t>-1&&this._tokens.splice(t,1),0===this._tokens.length?yield u.keychain.deleteToken():this.storeTokenData();const n=this._refreshTimeouts.get(e);n&&(clearTimeout(n),this._refreshTimeouts.delete(e))})}clearSessions(){return o(this,void 0,void 0,function*(){d.default.info("Logging out of all sessions"),this._tokens=[],yield u.keychain.deleteToken(),this._refreshTimeouts.forEach(e=>{clearTimeout(e)}),this._refreshTimeouts.clear()})}}},function(e,t){e.exports=require("crypto")},function(e,t){e.exports=require("https")},function(e,t){e.exports=require("querystring")},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))(function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){e.done?r(e.value):function(e){return e instanceof n?e:new n(function(t){t(e)})}(e.value).then(s,c)}a((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const r=n(7),i=n(8),s=n(9),c=n(10),a={number:"number",string:"string",undefined:"undefined",object:"object",function:"function"};function u(e){return typeof e===a.undefined}function d(e){return u(e)||null===e}function l(e){if(d(e))throw new Error("Assertion Failed: argument is undefined or null");return e}function h(e,t,n){s.readFile(t,(t,o)=>{t?(console.error(t),e.writeHead(404),e.end()):(e.writeHead(200,{"Content-Length":o.length,"Content-Type":n}),e.end(o))})}t.isUndefined=u,t.isUndefinedOrNull=d,t.assertIsDefined=l,t.createTerminateServer=function(e){const t={};let n=0;return e.on("connection",e=>{const o=n++;t[o]=e,e.on("close",()=>{delete t[o]})}),()=>o(this,void 0,void 0,function*(){const n=new Promise(t=>e.close(t));for(const e in t)t[e].destroy();return n})},t.startServer=function(e){return o(this,void 0,void 0,function*(){let t;function n(){clearTimeout(t)}const o=new Promise((n,o)=>{t=setTimeout(()=>{o(new Error("Timeout waiting for port"))},5e3),e.on("listening",()=>{const t=e.address();n("string"==typeof t?t:l(t).port.toString())}),e.on("error",e=>{o(new Error("Error listening to server"))}),e.on("close",()=>{o(new Error("Closed"))}),e.listen(0)});return o.then(n,n),o})},t.createServer=function(e){let t;const n=new Promise((e,n)=>t={resolve:e,reject:n});let s;const a=new Promise((e,t)=>s={resolve:e,reject:t}),u=setTimeout(()=>{s.reject(new Error("Timeout waiting for code"))},3e5);function d(){clearTimeout(u)}const l=r.createServer(function(n,r){const a=i.parse(n.url,!0);switch(a.pathname){case"/signin":if((a.query.nonce||"").replace(/ /g,"+")===e)t.resolve({req:n,res:r});else{const e=new Error("Nonce does not match.");t.resolve({err:e,res:r})}break;case"/":h(r,c.join(__dirname,"../media/auth.html"),"text/html; charset=utf-8");break;case"/auth.css":h(r,c.join(__dirname,"../media/auth.css"),"text/css; charset=utf-8");break;case"/callback":s.resolve(function(e,t){return o(this,void 0,void 0,function*(){const n=t.query;if(!n||"string"==typeof n)throw new Error("No query received.");let o=n.error_description||n.error;o||((n.state||"").split(",")[1]||"").replace(/ /g,"+")!==e&&(o="Nonce does not match.");const r=n.code;if(!o&&r)return r;throw new Error(o||"No code received.")})}(e,a).then(e=>({code:e,res:r}),e=>({err:e,res:r})));break;default:r.writeHead(404),r.end()}});return a.then(d,d),{server:l,redirectPromise:n,codePromise:a}}},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("url")},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("path")},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))(function(r,i){function s(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){e.done?r(e.value):function(e){return e instanceof n?e:new n(function(t){t(e)})}(e.value).then(s,c)}a((o=o.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const r=`${n(0).env.uriScheme}-vscode.login`,i="account";class s{constructor(){const e=function(){try{return n(12)}catch(e){console.log(e)}}();if(!e)throw new Error("System keychain unavailable");this.keytar=e}setToken(e){return o(this,void 0,void 0,function*(){try{return yield this.keytar.setPassword(r,i,e)}catch(e){}})}getToken(){return o(this,void 0,void 0,function*(){try{return yield this.keytar.getPassword(r,i)}catch(e){}})}deleteToken(){return o(this,void 0,void 0,function*(){try{return yield this.keytar.deletePassword(r,i)}catch(e){}})}}t.Keychain=s,t.keychain=new s},function(e,t){e.exports=require("keytar")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=n(0);function r(e,t,n=" "){return n.repeat(Math.max(0,t-e.length))+e}const i=new class{constructor(){this.output=o.window.createOutputChannel("Account")}data2String(e){return e instanceof Error?e.stack||e.message:!1===e.success&&e.message?e.message:e.toString()}info(e,t){this.logLevel("Info",e,t)}error(e,t){this.logLevel("Error",e,t)}logLevel(e,t,n){this.output.appendLine(`[${e}  - ${this.now()}] ${t}`),n&&this.output.appendLine(this.data2String(n))}now(){const e=new Date;return r(e.getUTCHours()+"",2,"0")+":"+r(e.getMinutes()+"",2,"0")+":"+r(e.getUTCSeconds()+"",2,"0")+"."+e.getMilliseconds()}};t.default=i},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toBase64UrlEncoding=function(e){return e.replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}}]));
//# sourceMappingURL=https://ticino.blob.core.windows.net/sourcemaps/ae08d5460b5a45169385ff3fd44208f431992451/extensions/vscode-account/dist/extension.js.map